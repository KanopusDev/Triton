<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.tailwindcss.com https://static.cloudflare.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://cdn.jsdelivr.net; connect-src 'self' https://cloudflareinsights.com">
    <title>Register - Triton AI</title>
    
    <!-- Core libraries -->
    <link rel="icon" href="/static/icons/logo.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons and styling - Use local Font Awesome -->
    <link rel="stylesheet" href="/static/css/fontawesome.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Custom JS -->
    <script src="/static/js/auth.js" defer></script>
    
    <!-- Tailwind custom theme configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        },
                        secondary: {
                            50: '#f5f7fa',
                            100: '#eaeef4',
                            200: '#d1dae7',
                            300: '#a6bad3',
                            400: '#7596ba',
                            500: '#5378a2',
                            600: '#3f5f87',
                            700: '#354e6f',
                            800: '#2f435e',
                            900: '#2b3a4f',
                            950: '#1a2333',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            700: '#15803d',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            500: '#f59e0b',
                            700: '#b45309',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            700: '#b91c1c',
                        },
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-secondary-50 text-secondary-900 font-sans antialiased">
    <div class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-lg shadow-md">
            <!-- Logo -->
            <div class="text-center">
                <img src="/static/icons/logo.svg" alt="Triton Logo" class="h-16 w-16 mx-auto" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”±</text></svg>'">
                <h2 class="mt-4 text-3xl font-bold text-secondary-900">Triton<span class="text-primary-600">AI</span></h2>
                <p class="mt-2 text-sm text-secondary-600">Create your account</p>
            </div>
            
            <!-- Registration Form -->
            <form id="register-form" class="mt-8 space-y-6">
                <!-- Error Alert -->
                <div id="error-message" class="bg-danger-50 text-danger-700 p-4 rounded-md border border-danger-200 hidden">
                    <div class="flex">
                        <i class="fas fa-exclamation-circle mt-0.5 mr-2"></i>
                        <span id="error-text"></span>
                    </div>
                </div>
                
                <!-- Success Alert -->
                <div id="success-message" class="bg-success-50 text-success-700 p-4 rounded-md border border-success-200 hidden">
                    <div class="flex">
                        <i class="fas fa-check-circle mt-0.5 mr-2"></i>
                        <span id="success-text"></span>
                    </div>
                </div>
                
                <!-- Username Field -->
                <div>
                    <label for="username" class="block text-sm font-medium text-secondary-700 mb-1">Username</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-secondary-500">
                            <i class="fas fa-user"></i>
                        </div>
                        <input id="username" name="username" type="text" required class="w-full pl-10 px-3 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Your name">
                    </div>
                </div>
                
                <!-- Email Field -->
                <div>
                    <label for="email" class="block text-sm font-medium text-secondary-700 mb-1">Email Address</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-secondary-500">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <input id="email" name="email" type="email" required class="w-full pl-10 px-3 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="your@email.com">
                    </div>
                    <p class="mt-1 text-xs text-secondary-500">Must match the email from your invitation</p>
                </div>
                
                <!-- Password Field -->
                <div>
                    <label for="password" class="block text-sm font-medium text-secondary-700 mb-1">Password</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-secondary-500">
                            <i class="fas fa-lock"></i>
                        </div>
                        <input id="password" name="password" type="password" required class="w-full pl-10 px-3 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <p class="mt-1 text-xs text-secondary-500">Minimum 8 characters</p>
                </div>
                
                <!-- Confirm Password Field -->
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-secondary-700 mb-1">Confirm Password</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-secondary-500">
                            <i class="fas fa-lock"></i>
                        </div>
                        <input id="confirm-password" name="confirm-password" type="password" required class="w-full pl-10 px-3 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                </div>
                
                <!-- Invitation Token (hidden, populated from URL) -->
                <input type="hidden" id="invitation-token" name="invitation-token">
                
                <!-- Submit Button -->
                <div>
                    <button type="submit" id="register-button" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <span id="button-text">Create Account</span>
                        <span id="button-spinner" class="hidden">
                            <i class="fas fa-spinner fa-spin ml-2"></i>
                        </span>
                    </button>
                </div>
                
                <!-- Login Link -->
                <div class="text-center text-sm text-secondary-600">
                    <p>Already have an account? <a href="/login" class="font-medium text-primary-600 hover:text-primary-500">Sign in</a></p>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('register-form');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const successMessage = document.getElementById('success-message');
            const successText = document.getElementById('success-text');
            const buttonText = document.getElementById('button-text');
            const buttonSpinner = document.getElementById('button-spinner');
            
            // Parse URL parameters for invitation token and email
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            
            // Pre-fill the form if parameters exist
            if (token) {
                document.getElementById('invitation-token').value = token;
            }
            
            if (email) {
                document.getElementById('email').value = email;
                // Make email field readonly if provided from URL
                document.getElementById('email').readOnly = true;
            }
            
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Get form data
                const username = document.getElementById('username').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const invitationToken = document.getElementById('invitation-token').value;
                
                // Simple validation
                if (!username || !email || !password) {
                    showError('Please fill out all required fields');
                    return;
                }
                
                if (password.length < 8) {
                    showError('Password must be at least 8 characters long');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }
                
                if (!invitationToken) {
                    showError('Invitation token is required. Please use the invitation link you received');
                    return;
                }
                
                // Show loading state
                setLoading(true);
                
                try {
                    // Send registration request
                    const response = await fetch('/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username,
                            email,
                            password,
                            invitation_token: invitationToken
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Registration successful
                        showSuccess('Account created successfully! Redirecting to dashboard...');
                        
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        // Show error
                        showError(data.error || 'Registration failed');
                    }
                } catch (error) {
                    showError('An unexpected error occurred. Please try again later.');
                    console.error('Registration error:', error);
                } finally {
                    setLoading(false);
                }
            });
            
            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
            }
            
            function showSuccess(message) {
                successText.textContent = message;
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            }
            
            function setLoading(isLoading) {
                if (isLoading) {
                    buttonText.textContent = 'Creating Account...';
                    buttonSpinner.classList.remove('hidden');
                    document.getElementById('register-button').disabled = true;
                } else {
                    buttonText.textContent = 'Create Account';
                    buttonSpinner.classList.add('hidden');
                    document.getElementById('register-button').disabled = false;
                }
            }
        });
    </script>
</body>
</html>
