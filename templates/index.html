<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.tailwindcss.com https://static.cloudflareinsights.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net data:; connect-src 'self' https://cloudflareinsights.com">
    <title>Triton AI</title>
    
    <!-- Core libraries -->
    <link rel="icon" href="/static/icons/logo.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Icons and styling -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <!-- Custom JS - Load notification service BEFORE Alpine.js -->
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="/static/js/notification-service.js" defer></script>
    <script src="/static/js/auth.js" defer></script>
    <script src="/static/js/app.js" defer></script>
    
    <!-- Load Alpine.js AFTER all component scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Sanitizer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- Tailwind custom theme configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        },
                        secondary: {
                            50: '#f5f7fa',
                            100: '#eaeef4',
                            200: '#d1dae7',
                            300: '#a6bad3',
                            400: '#7596ba',
                            500: '#5378a2',
                            600: '#3f5f87',
                            700: '#354e6f',
                            800: '#2f435e',
                            900: '#2b3a4f',
                            950: '#1a2333',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            700: '#15803d',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            500: '#f59e0b',
                            700: '#b45309',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            700: '#b91c1c',
                        },
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-secondary-50 text-secondary-900 font-sans antialiased">
    <div x-data="chatApp()" x-init="initialize()" x-cloak>
        <!-- Auth check - redirect to login if not authenticated -->
        <div x-show="!isAuthenticated && !isCheckingAuth" x-transition class="fixed inset-0 flex items-center justify-center bg-secondary-900/90 z-50">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full text-center">
                <div class="text-5xl text-primary-500 mb-6">
                    <i class="fas fa-lock"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4">Authentication Required</h2>
                <p class="mb-6 text-secondary-600">Please log in to access Triton AI</p>
                <a href="/login" class="inline-block bg-primary-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-primary-700 transition-colors">
                    Go to Login
                </a>
            </div>
        </div>
        
        <!-- Loading Screen -->
        <div x-show="isCheckingAuth" x-transition class="fixed inset-0 flex items-center justify-center bg-secondary-50 z-50">
            <div class="text-center">
                <div class="inline-block">
                    <svg class="animate-spin h-12 w-12 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="mt-4 text-secondary-600">Initializing application...</p>
            </div>
        </div>
        
        <!-- Main Application -->
        <div x-show="isAuthenticated" x-transition>
            <!-- Header -->
            <header class="bg-white border-b border-secondary-200 px-4 py-3 flex justify-between items-center shadow-sm z-10 h-16">
                <div class="flex items-center space-x-4">
                    <button @click="toggleSidebar" class="text-secondary-500 hover:text-primary-600 transition-colors p-2 rounded-md">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center">
                        <img src="/static/icons/logo.svg" alt="Triton Logo" class="h-8 w-8 mr-3" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”±</text></svg>'">
                        <h1 class="text-xl font-semibold text-secondary-900">Triton<span class="text-primary-600">AI</span></h1>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="hidden md:block relative group">
                        <span class="text-secondary-600 text-sm font-medium mr-2">Status:</span>
                        <span class="inline-flex items-center">
                            <span class="h-2.5 w-2.5 rounded-full bg-success-500 mr-2 animate-pulse"></span>
                            <span class="text-secondary-700 font-medium">Online</span>
                        </span>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="relative" x-data="{ open: false }" @click.outside="open = false">
                        <button 
                            @click="open = !open"
                            class="flex items-center space-x-2 text-secondary-700 hover:text-secondary-900 focus:outline-none"
                        >
                            <div class="w-8 h-8 bg-primary-100 text-primary-700 rounded-full flex items-center justify-center">
                                <span x-text="userInitials" class="font-medium text-sm"></span>
                            </div>
                            <span x-text="userName" class="hidden md:inline-block font-medium"></span>
                            <i class="fas fa-chevron-down text-xs text-secondary-400"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div 
                            x-show="open" 
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-secondary-100 z-50"
                        >
                            <div class="p-4">
                                <p class="font-medium text-secondary-900" x-text="userName"></p>
                                <p class="text-sm text-secondary-500" x-text="userEmail"></p>
                                <div class="mt-1 text-xs inline-block bg-primary-50 text-primary-700 py-0.5 px-2 rounded-full" x-text="userRole === 'admin' ? 'Administrator' : 'User'"></div>
                            </div>
                            
                            <div class="p-2">
                                <template x-if="userRole === 'admin'">
                                    <a href="/admin" class="flex items-center px-4 py-2 text-sm text-secondary-700 hover:bg-secondary-50 rounded-md">
                                        <i class="fas fa-users-cog w-5 mr-2 text-secondary-500"></i>
                                        Admin Panel
                                    </a>
                                </template>
                                
                                <a href="/profile" class="flex items-center px-4 py-2 text-sm text-secondary-700 hover:bg-secondary-50 rounded-md">
                                    <i class="fas fa-user-circle w-5 mr-2 text-secondary-500"></i>
                                    Profile
                                </a>
                                
                                <a href="/settings" class="flex items-center px-4 py-2 text-sm text-secondary-700 hover:bg-secondary-50 rounded-md">
                                    <i class="fas fa-cog w-5 mr-2 text-secondary-500"></i>
                                    Settings
                                </a>
                                
                                <button 
                                    @click="showInviteModal = true; open = false"
                                    class="w-full text-left flex items-center px-4 py-2 text-sm text-secondary-700 hover:bg-secondary-50 rounded-md"
                                >
                                    <i class="fas fa-user-plus w-5 mr-2 text-secondary-500"></i>
                                    Invite User
                                </button>
                            </div>
                            
                            <div class="p-2">
                                <button 
                                    @click="logout" 
                                    class="w-full text-left flex items-center px-4 py-2 text-sm text-danger-600 hover:bg-danger-50 rounded-md"
                                >
                                    <i class="fas fa-sign-out-alt w-5 mr-2"></i>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button 
                        @click.prevent="startNewChat()" 
                        :disabled="isLoading"
                        class="btn bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center font-medium hover:bg-primary-700 transition-colors shadow-sm"
                        :class="{'opacity-50 cursor-not-allowed': isLoading}"
                    >
                        <i class="fas fa-plus mr-2"></i>
                        <span x-text="isLoading ? 'Starting...' : 'New Chat'"></span>
                    </button>
                </div>
            </header>

            <div class="chat-container">
                <!-- Sidebar -->
                <aside 
                    x-show="sidebarOpen" 
                    x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="-translate-x-full"
                    x-transition:enter-end="translate-x-0"
                    x-transition:leave="transition ease-in duration-300"
                    x-transition:leave-start="translate-x-0"
                    x-transition:leave-end="-translate-x-full"
                    @click.outside="if(window.innerWidth < 1024) sidebarOpen = false"
                    class="fixed lg:relative lg:flex w-80 h-[calc(100vh-64px)] bg-white border-r border-secondary-200 flex-col z-20"
                >
                    <!-- Sidebar Header with Search -->
                    <div class="p-4 border-b border-secondary-100">
                        <div class="relative">
                            <input 
                                type="text" 
                                x-model="searchQuery" 
                                @input="searchConversations"
                                placeholder="Search conversations..." 
                                class="w-full px-4 py-2 pl-10 border border-secondary-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-secondary-900"
                            >
                            <i class="fas fa-search absolute left-3.5 top-3 text-secondary-400"></i>
                            <button 
                                x-show="searchQuery" 
                                @click="searchQuery = ''; searchConversations()"
                                class="absolute right-3 top-2.5 text-secondary-400 hover:text-secondary-700"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Conversation List -->
                    <div class="flex-1 overflow-y-auto">
                        <div x-show="filteredConversations.length === 0" class="p-6 text-center">
                            <div class="text-secondary-400 mb-2">
                                <i class="fas fa-comments fa-2x"></i>
                            </div>
                            <p class="text-secondary-600 text-sm">
                                No conversations found
                            </p>
                            <button @click="startNewChat" class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                                Start new chat
                            </button>
                        </div>
                        
                        <template x-for="conversation in filteredConversations" :key="conversation.conversation_id">
                            <div 
                                :class="{'border-l-4 border-primary-500 bg-primary-50': currentConversationId === conversation.conversation_id}"
                                class="hover:bg-secondary-50 transition-colors cursor-pointer border-b border-secondary-100"
                            >
                                <div class="p-4">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1 pr-2" @click="loadConversation(conversation.conversation_id)">
                                            <h3 class="font-medium text-secondary-900 truncate" x-text="conversation.conversation_name || 'Untitled Conversation'"></h3>
                                            <p class="text-sm text-secondary-500 mt-1 truncate" x-text="conversation.first_message"></p>
                                            <div class="text-xs text-secondary-400 mt-1 flex items-center">
                                                <i class="far fa-clock mr-1.5"></i>
                                                <span x-text="formatDate(conversation.last_message)"></span>
                                                <span class="mx-1.5">â€¢</span>
                                                <span x-text="conversation.message_count + ' message' + (conversation.message_count !== 1 ? 's' : '')"></span>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <button 
                                                @click.stop="openRenameModal(conversation)"
                                                class="text-secondary-400 hover:text-secondary-600 transition-colors p-1.5 rounded-full hover:bg-secondary-100 mr-1"
                                            >
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button 
                                                @click.stop="confirmDelete(conversation.conversation_id)"
                                                class="text-secondary-400 hover:text-danger-500 transition-colors p-1.5 rounded-full hover:bg-secondary-100"
                                            >
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Sidebar Footer -->
                    <div class="p-4 bg-secondary-50 border-t border-secondary-200">
                        <div class="flex items-center justify-between text-sm text-secondary-600">
                            <a href="https://github.com/gamecooler19" target="_blank" class="hover:text-primary-600 transition-colors flex items-center">
                                <i class="fab fa-github mr-2"></i>
                                <span>GitHub</span>
                            </a>
                            <a href="#" @click.prevent="showKeyboardShortcuts = true" class="hover:text-primary-600 transition-colors flex items-center">
                                <i class="fas fa-keyboard mr-2"></i>
                                <span>Shortcuts</span>
                            </a>
                            <a href="#" @click.prevent="showInfoModal = true" class="hover:text-primary-600 transition-colors flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                <span>About</span>
                            </a>
                        </div>
                    </div>
                </aside>
                
                <!-- Main Chat Area -->
                <main class="flex-1 flex flex-col bg-secondary-50 relative overflow-hidden">
                    <!-- Loading State -->
                    <div 
                        x-show="state === 'loading'" 
                        class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 z-10"
                    >
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-3x text-primary-500 mb-4"></i>
                            <p class="text-secondary-600">Loading...</p>
                        </div>
                    </div>
                    
                    <!-- Welcome Screen -->
                    <div 
                        x-show="state === 'welcome' && !currentMessages.length" 
                        class="flex-1 flex flex-col items-center justify-center p-6"
                    >
                        <div class="max-w-lg text-center">
                            <div class="mb-8">
                                <div class="inline-block p-4 rounded-full bg-primary-100 text-primary-600 mb-4">
                                    <i class="fas fa-robot fa-3x"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-secondary-900 mb-2">Welcome to TritonAI</h2>
                                <p class="text-secondary-600">Your advanced enterprise assistant powered by state-of-the-art language models.</p>
                            </div>
                            
                            <!-- Feature cards -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                                <div class="bg-white p-4 rounded-lg border border-secondary-200 shadow-sm">
                                    <div class="text-primary-600 mb-2"><i class="fas fa-search"></i></div>
                                    <h3 class="font-medium mb-1">Web Search</h3>
                                    <p class="text-sm text-secondary-600">Get real-time information from the web</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-secondary-200 shadow-sm">
                                    <div class="text-primary-600 mb-2"><i class="fas fa-brain"></i></div>
                                    <h3 class="font-medium mb-1">Reasoning</h3>
                                    <p class="text-sm text-secondary-600">Follow the AI's step-by-step thinking</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-secondary-200 shadow-sm">
                                    <div class="text-primary-600 mb-2"><i class="fas fa-file-alt"></i></div>
                                    <h3 class="font-medium mb-1">Document Processing</h3>
                                    <p class="text-sm text-secondary-600">Analyze and extract insights from files</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-secondary-200 shadow-sm">
                                    <div class="text-primary-600 mb-2"><i class="fas fa-robot"></i></div>
                                    <h3 class="font-medium mb-1">Multiple Models</h3>
                                    <p class="text-sm text-secondary-600">Choose from various AI models</p>
                                </div>
                            </div>
                            
                            <button 
                                @click="startNewChat" 
                                class="px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium flex items-center justify-center"
                            >
                                <i class="fas fa-plus mr-2"></i>
                                Start a new conversation
                            </button>
                        </div>
                    </div>
                    
                    <!-- Chat Interface -->
                    <div 
                        x-show="state === 'chat' || currentMessages.length > 0"
                        class="flex flex-col h-full"
                    >
                        <!-- Model & Features Selection -->
                        <div class="bg-white border-b border-secondary-200 p-4">
                            <div class="flex flex-wrap gap-4 items-start">
                                <!-- Model Selector -->
                                <div class="flex-grow min-w-[200px] max-w-xs">
                                    <label class="block text-xs font-medium text-secondary-700 mb-1.5">AI Model</label>
                                    <div class="relative">
                                        <select 
                                            x-model="selectedModel" 
                                            class="appearance-none w-full px-3 py-2 pl-10 border border-secondary-200 rounded-lg bg-white focus:ring-2 focus:ring-primary-500 focus:border-transparent text-secondary-900 pr-10"
                                        >
                                            <template x-for="category in modelCategories" :key="category.name">
                                                <optgroup :label="category.name">
                                                    <template x-for="model in category.models" :key="model.id">
                                                        <option :value="model.id" x-text="model.name"></option>
                                                    </template>
                                                </optgroup>
                                            </template>
                                        </select>
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none text-secondary-500">
                                            <i class="fas fa-microchip"></i>
                                        </div>
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3.5 pointer-events-none text-secondary-500">
                                            <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Feature Toggles Grid -->
                                <div class="flex-grow grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <!-- Web Search Toggle -->
                                    <div class="toggle-card" :class="{ 'border-primary-300': features.search }">
                                        <div class="toggle-status" :class="{ 'toggle-status-active': features.search }"></div>
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-3">
                                                <span class="flex items-center justify-center w-8 h-8 rounded-md bg-primary-50 text-primary-600">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <span class="font-medium">Web Search</span>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    x-model="features.search"
                                                    @change="saveFeaturePreferences"
                                                    class="sr-only peer"
                                                >
                                                <div class="w-11 h-6 bg-secondary-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-secondary-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                            </label>
                                        </div>
                                        <p class="mt-2 text-sm text-secondary-600">
                                            Access real-time information from the web
                                        </p>
                                    </div>

                                    <!-- Reasoning Toggle -->
                                    <div class="toggle-card" :class="{ 'border-primary-300': features.reasoning }">
                                        <div class="toggle-status" :class="{ 'toggle-status-active': features.reasoning }"></div>
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-3">
                                                <span class="flex items-center justify-center w-8 h-8 rounded-md bg-primary-50 text-primary-600">
                                                    <i class="fas fa-brain"></i>
                                                </span>
                                                <span class="font-medium">Reasoning</span>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    x-model="features.reasoning"
                                                    @change="saveFeaturePreferences"
                                                    class="sr-only peer"
                                                >
                                                <div class="w-11 h-6 bg-secondary-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-secondary-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                            </label>
                                        </div>
                                        <p class="mt-2 text-sm text-secondary-600">
                                            Follow AI's step-by-step analysis process
                                        </p>
                                    </div>
                                    
                                    <!-- Deep Research Toggle -->
                                    <div class="toggle-card" :class="{ 'border-primary-300': features.deep_research }">
                                        <div class="toggle-status" :class="{ 'toggle-status-active': features.deep_research }"></div>
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-3">
                                                <span class="flex items-center justify-center w-8 h-8 rounded-md bg-primary-50 text-primary-600">
                                                    <i class="fas fa-microscope"></i>
                                                </span>
                                                <span class="font-medium">Deep Research</span>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    x-model="features.deep_research"
                                                    @change="saveFeaturePreferences"
                                                    class="sr-only peer"
                                                >
                                                <div class="w-11 h-6 bg-secondary-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-secondary-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                            </label>
                                        </div>
                                        <p class="mt-2 text-sm text-secondary-600">
                                            Perform thorough multi-step research
                                        </p>
                                    </div>
                                    
                                    <!-- Document Processing Toggle -->
                                    <div class="toggle-card" :class="{ 'border-primary-300': features.document }">
                                        <div class="toggle-status" :class="{ 'toggle-status-active': features.document }"></div>
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-3">
                                                <span class="flex items-center justify-center w-8 h-8 rounded-md bg-primary-50 text-primary-600">
                                                    <i class="fas fa-file-alt"></i>
                                                </span>
                                                <span class="font-medium">Document Processing</span>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    x-model="features.document"
                                                    @change="saveFeaturePreferences"
                                                    class="sr-only peer"
                                                >
                                                <div class="w-11 h-6 bg-secondary-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-secondary-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                            </label>
                                        </div>
                                        <p class="mt-2 text-sm text-secondary-600">
                                            Analyze and extract insights from documents
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div 
                            class="flex-1 overflow-y-auto messages-container" 
                            id="messages"
                            @scroll="handleScroll"
                        >
                            <div x-show="currentMessages.length === 0 && state === 'chat'" class="p-6 text-center text-secondary-500">
                                <p>Start the conversation by sending a message below.</p>
                            </div>
                            
                            <template x-for="(message, index) in currentMessages" :key="message.message_id || index">
                                <div class="mb-6" :class="{'opacity-50': isRegenerating && index === currentMessages.length - 1}">
                                    <!-- User Message -->
                                    <div class="flex items-start mb-4 message-enter">
                                        <div class="w-8 h-8 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center mr-4">
                                            <i class="fas fa-user text-sm"></i>
                                        </div>
                                        <div class="message-bubble user-message px-4 py-2.5">
                                            <p class="text-white break-words" x-text="message.user_message"></p>
                                            <div class="flex justify-end items-center mt-1 text-primary-200 text-xs">
                                                <span x-text="formatTime(message.timestamp)"></span>
                                                
                                                <button 
                                                    @click="copyToClipboard(message.user_message)" 
                                                    class="ml-2 hover:text-white"
                                                    title="Copy message"
                                                >
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Assistant Message (only render if exists) -->
                                    <div class="flex items-start message-enter" x-show="message.assistant_message">
                                        <div class="w-8 h-8 rounded-full bg-secondary-100 text-secondary-600 flex items-center justify-center mr-4">
                                            <i class="fas fa-robot text-sm"></i>
                                        </div>
                                        <div class="message-bubble assistant-message px-4 py-2.5">
                                            <!-- Message Content -->
                                            <div x-data="{ showRawHTML: false }">
                                                <div x-show="!showRawHTML" class="prose prose-sm max-w-none message-content" x-html="formatMarkdown(message.assistant_message)"></div>
                                                <pre x-show="showRawHTML" class="text-xs p-2 bg-gray-100 rounded overflow-auto max-h-60 mt-2" x-text="message.assistant_message"></pre>
                                                
                                                <div class="flex justify-end">
                                                    <button @click="showRawHTML = !showRawHTML" class="text-xs text-secondary-500 hover:text-secondary-700">
                                                        <span x-text="showRawHTML ? 'Show Formatted' : 'View HTML'"></span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Sources Panel - Only show if search results exist -->
                                            <div x-data="{ expanded: false, activeCitation: null }" x-show="message.search_context && Array.isArray(message.search_context) && message.search_context.length > 0" class="mt-4 border-t border-secondary-100 pt-3">
                                                <button 
                                                    @click="expanded = !expanded" 
                                                    class="flex items-center text-sm text-secondary-700 hover:text-primary-600 font-medium transition-colors"
                                                    :aria-expanded="expanded"
                                                    aria-controls="source-panel"
                                                >
                                                    <div class="flex items-center justify-center w-5 h-5 mr-2 rounded-full bg-primary-50 text-primary-600">
                                                        <i :class="expanded ? 'fa-chevron-down' : 'fa-chevron-right'" class="fas text-xs transition-transform duration-200"></i>
                                                    </div>
                                                    <span class="mr-1.5">Source Citations</span>
                                                    <span class="text-secondary-400 text-xs">(<span x-text="message.search_context ? message.search_context.length : 0"></span>)</span>
                                                </button>
                                                
                                                <div 
                                                    id="source-panel"
                                                    x-show="expanded" 
                                                    x-transition:enter="transition ease-out duration-200" 
                                                    x-transition:enter-start="opacity-0 -translate-y-1" 
                                                    x-transition:enter-end="opacity-100 translate-y-0" 
                                                    class="mt-3"
                                                >
                                                    <div class="rounded-md border border-secondary-200 divide-y divide-secondary-100 shadow-sm bg-white overflow-hidden">
                                                        <template x-for="(source, index) in message.search_context" :key="index">
                                                            <div 
                                                                class="source-item p-3 hover:bg-secondary-50 transition-colors duration-150"
                                                                :class="{'bg-secondary-50': activeCitation === index}"
                                                                @mouseenter="activeCitation = index"
                                                                @mouseleave="activeCitation = null"
                                                            >
                                                                <div class="flex items-start">
                                                                    <!-- Citation Number -->
                                                                    <div class="flex-shrink-0 w-7 h-7 rounded-full bg-primary-100 text-primary-700 font-medium flex items-center justify-center mr-3">
                                                                        <span x-text="index + 1"></span>
                                                                    </div>
                                                                    
                                                                    <!-- Source Content -->
                                                                    <div class="flex-1 min-w-0">
                                                                        <div class="flex justify-between items-start">
                                                                            <a 
                                                                                :href="source.link" 
                                                                                target="_blank" 
                                                                                rel="noopener noreferrer"
                                                                                class="text-primary-600 hover:text-primary-800 font-medium line-clamp-1 flex-1 break-words"
                                                                                x-text="source.title"
                                                                                @click.stop
                                                                            ></a>
                                                                        </div>
                                                                        
                                                                        <p class="text-secondary-700 line-clamp-2 mt-1 text-sm" x-text="source.snippet"></p>
                                                                        
                                                                        <div class="mt-2 flex items-center justify-between">
                                                                            <!-- URL and Domain -->
                                                                            <div class="flex items-center text-xs text-secondary-500 max-w-[70%]">
                                                                                <i class="fas fa-globe mr-1.5"></i>
                                                                                <span 
                                                                                    class="truncate" 
                                                                                    x-text="new URL(source.link).hostname.replace('www.', '')"
                                                                                    :title="source.link"
                                                                                ></span>
                                                                            </div>
                                                                            
                                                                            <!-- Actions -->
                                                                            <div class="flex items-center space-x-2">
                                                                                <!-- Credibility Indicator - Simple version -->
                                                                                <div x-data="{ showCredInfo: false }" class="relative">
                                                                                    <span 
                                                                                        class="inline-flex h-5 px-1.5 items-center rounded text-xs bg-secondary-100 text-secondary-700"
                                                                                        @mouseenter="showCredInfo = true"
                                                                                        @mouseleave="showCredInfo = false"
                                                                                    >
                                                                                        <i class="fas fa-check-circle text-success-500 mr-1"></i>
                                                                                        <span>Source</span>
                                                                                    </span>
                                                                                    
                                                                                    <!-- Tooltip -->
                                                                                    <div 
                                                                                        x-show="showCredInfo" 
                                                                                        x-transition 
                                                                                        class="absolute bottom-full mb-1 right-0 z-10 w-48 rounded-md bg-secondary-800 text-white text-xs p-2 shadow-lg"
                                                                                    >
                                                                                        This source comes from a public website. Evaluate information critically.
                                                                                    </div>
                                                                                </div>
                                                                                
                                                                                <!-- Copy URL button -->
                                                                                <div x-data="{ copied: false }">
                                                                                    <button 
                                                                                        @click.stop="copied = true; copyToClipboard(source.link); setTimeout(() => copied = false, 2000)" 
                                                                                        class="flex items-center justify-center w-6 h-6 rounded-full hover:bg-secondary-100 text-secondary-500 hover:text-primary-600 transition-colors"
                                                                                        :aria-label="'Copy URL for ' + source.title"
                                                                                    >
                                                                                        <i class="fas" :class="copied ? 'fa-check text-success-500' : 'fa-copy'"></i>
                                                                                    </button>
                                                                                </div>
                                                                                
                                                                                <!-- Citation Button - for academic contexts -->
                                                                                <div x-data="{ showCitation: false }">
                                                                                    <button 
                                                                                        @click.stop="showCitation = !showCitation" 
                                                                                        class="flex items-center justify-center w-6 h-6 rounded-full hover:bg-secondary-100 text-secondary-500 hover:text-primary-600 transition-colors"
                                                                                        :aria-label="'Show citation for ' + source.title"
                                                                                    >
                                                                                        <i class="fas fa-quote-right"></i>
                                                                                    </button>
                                                                                    
                                                                                    <!-- Citation panel -->
                                                                                    <div 
                                                                                        x-show="showCitation" 
                                                                                        x-transition 
                                                                                        class="mt-2 p-2 bg-secondary-50 rounded-md text-xs border border-secondary-200"
                                                                                    >
                                                                                        <div class="flex justify-between items-center mb-1">
                                                                                            <span class="font-medium">Citation</span>
                                                                                            <button 
                                                                                                @click.stop="copyToClipboard('[' + (index + 1) + '] ' + source.title + '. Retrieved from ' + source.link)"
                                                                                                class="text-primary-600 hover:text-primary-800"
                                                                                            >
                                                                                                <i class="fas fa-copy"></i>
                                                                                            </button>
                                                                                        </div>
                                                                                        <p class="text-secondary-700">
                                                                                            <span x-text="'[' + (index + 1) + '] ' + source.title + '. Retrieved from ' + source.link"></span>
                                                                                        </p>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                    
                                                    <!-- Source panel footer with explanation -->
                                                    <div class="mt-2 text-xs text-secondary-500 px-1 flex items-center">
                                                        <i class="fas fa-info-circle mr-1.5"></i>
                                                        <span>Sources are retrieved from web search and may need verification.</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Reasoning Panel - Only show if reasoning exists -->
                                            <div x-data="{ expanded: false }" x-show="message.reasoning && message.reasoning.length > 0" class="mt-3 border-t border-secondary-100 pt-2">
                                                <button @click="expanded = !expanded" class="flex items-center text-xs text-secondary-700 hover:text-primary-600 font-medium">
                                                    <i :class="expanded ? 'fa-chevron-down' : 'fa-chevron-right'" class="fas mr-1.5 w-3"></i>
                                                    <span>Reasoning Process</span>
                                                </button>
                                                
                                                <div x-show="expanded" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="mt-2 bg-secondary-50 rounded-md p-3 text-sm">
                                                    <div class="prose prose-sm max-w-none" x-html="formatMarkdown(message.reasoning)"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- Message Actions -->
                                            <div class="flex justify-between mt-2 pt-2 border-t border-secondary-100">
                                                <div class="flex items-center space-x-2 text-secondary-500 text-xs">
                                                    <span x-text="formatTime(message.timestamp)"></span>
                                                    <span class="text-secondary-300">â€¢</span>
                                                    <span x-text="message.model ? (message.model.includes('/') ? message.model.split('/')[1] : message.model) : 'AI'"></span>
                                                    
                                                    <!-- Feature indicators -->
                                                    <template x-if="message.features && (message.features.search || message.features.reasoning || message.features.deep_research)">
                                                        <span class="text-secondary-300">|</span>
                                                    </template>
                                                    <template x-if="message.features && message.features.search">
                                                        <span title="Web search enabled" class="text-primary-600"><i class="fas fa-search"></i></span>
                                                    </template>
                                                    <template x-if="message.features && message.features.reasoning">
                                                        <span title="Reasoning enabled" class="text-primary-600"><i class="fas fa-brain"></i></span>
                                                    </template>
                                                    <template x-if="message.features && message.features.deep_research">
                                                        <span title="Deep research enabled" class="text-primary-600"><i class="fas fa-microscope"></i></span>
                                                    </template>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button 
                                                        @click="copyToClipboard(message.assistant_message)" 
                                                        class="text-secondary-500 hover:text-secondary-700 p-1"
                                                        title="Copy response"
                                                    >
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                    <button 
                                                        @click="regenerateResponse(index)"
                                                        class="text-secondary-500 hover:text-secondary-700 p-1"
                                                        title="Regenerate response"
                                                        :disabled="isRegenerating"
                                                    >
                                                        <i class="fas fa-sync-alt" :class="{'fa-spin': isRegenerating && index === currentMessages.length - 1}"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- AI is thinking indicator -->
                            <div 
                                x-show="isThinking" 
                                class="flex items-start mb-6 message-enter"
                            >
                                <div class="w-8 h-8 rounded-full bg-secondary-100 text-secondary-600 flex items-center justify-center mr-4">
                                    <i class="fas fa-robot text-sm"></i>
                                </div>
                                <div class="message-bubble assistant-message px-4 py-2.5 flex items-center">
                                    <div class="typing-indicator">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div class="bg-white border-t border-secondary-200 p-4">
                            <div class="max-w-4xl mx-auto">
                                <form @submit.prevent="sendMessage">
                                    <div class="relative">
                                        <textarea 
                                            x-model="newMessage" 
                                            @keydown.enter.prevent="handleEnterKey($event)"
                                            placeholder="Send a message..."
                                            class="w-full px-4 py-3 pr-16 border border-secondary-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
                                            :class="{'h-12': newMessage.length === 0, 'h-32': newMessage.length > 0}"
                                            :disabled="isThinking || isRegenerating"
                                        ></textarea>
                                        
                                        <div class="absolute right-2 bottom-2 flex items-center space-x-1">
                                            <button 
                                                type="button"
                                                @click="openDocumentUpload"
                                                class="text-secondary-500 hover:text-secondary-700 p-2 rounded hover:bg-secondary-50"
                                                title="Attach document"
                                            >
                                                <i class="fas fa-paperclip"></i>
                                            </button>
                                            <button 
                                                type="submit" 
                                                class="bg-primary-600 text-white p-2 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                :disabled="newMessage.trim() === '' || isThinking || isRegenerating"
                                            >
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- Modals -->
        <!-- Delete Confirmation Modal -->
        <div 
            x-show="showDeleteModal" 
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="bg-white rounded-lg shadow-xl max-w-md w-full p-6"
                @click.outside="showDeleteModal = false"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
            >
                <div class="flex items-center justify-center text-danger-500 mb-4">
                    <i class="fas fa-exclamation-triangle text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-secondary-900 mb-2 text-center">Delete Conversation</h3>
                <p class="text-secondary-600 mb-6 text-center">Are you sure you want to delete this conversation? This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button 
                        @click="showDeleteModal = false" 
                        class="px-4 py-2 border border-secondary-300 rounded-lg text-secondary-700 hover:bg-secondary-50"
                    >
                        Cancel
                    </button>
                    <button 
                        @click="deleteConversation(conversationToDelete)" 
                        class="px-4 py-2 bg-danger-600 text-white rounded-lg hover:bg-danger-700"
                    >
                        Delete
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Rename Conversation Modal -->
        <div 
            x-show="showRenameModal" 
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="bg-white rounded-lg shadow-xl max-w-md w-full p-6"
                @click.outside="showRenameModal = false"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
            >
                <h3 class="text-xl font-bold text-secondary-900 mb-4">Rename Conversation</h3>
                <div class="mb-4">
                    <label for="conversation-name" class="block text-sm font-medium text-secondary-700 mb-1">Name</label>
                    <input 
                        type="text" 
                        id="conversation-name" 
                        x-model="newConversationName" 
                        class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                        placeholder="Enter conversation name"
                    >
                </div>
                <div class="flex justify-end space-x-3">
                    <button 
                        @click="showRenameModal = false" 
                        class="px-4 py-2 border border-secondary-300 rounded-lg text-secondary-700 hover:bg-secondary-50"
                    >
                        Cancel
                    </button>
                    <button 
                        @click="renameConversation" 
                        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700"
                        :disabled="!newConversationName.trim()"
                    >
                        Save
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Invite User Modal -->
        <div 
            x-show="showInviteModal" 
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="bg-white rounded-lg shadow-xl max-w-md w-full p-6"
                @click.outside="showInviteModal = false"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
            >
                <h3 class="text-xl font-bold text-secondary-900 mb-4">Invite User</h3>
                
                <div x-show="inviteSuccess" class="mb-4 p-3 bg-success-50 text-success-700 rounded-md border border-success-200">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>Invitation sent successfully!</span>
                    </div>
                </div>
                
                <div x-show="inviteError" class="mb-4 p-3 bg-danger-50 text-danger-700 rounded-md border border-danger-200">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span x-text="inviteError"></span>
                    </div>
                </div>
                
                <form @submit.prevent="sendInvitation">
                    <div class="mb-4">
                        <label for="invite-email" class="block text-sm font-medium text-secondary-700 mb-1">Email Address</label>
                        <input 
                            type="email" 
                            id="invite-email" 
                            x-model="inviteEmail" 
                            class="w-full px-3 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            placeholder="colleague@example.com"
                            required
                        >
                        <p class="mt-1 text-xs text-secondary-500">The user will receive an invitation link to register</p>
                    </div>
                    
                    <div x-show="invitationUrl" class="mb-4">
                        <label class="block text-sm font-medium text-secondary-700 mb-1">Invitation Link</label>
                        <div class="flex">
                            <input 
                                type="text" 
                                :value="invitationUrl" 
                                class="w-full px-3 py-2 border border-secondary-300 rounded-l-lg bg-secondary-50 text-secondary-800"
                                readonly
                            >
                            <button 
                                type="button"
                                @click="copyToClipboard(invitationUrl)"
                                class="bg-secondary-100 border border-secondary-300 border-l-0 rounded-r-lg px-3 text-secondary-700 hover:bg-secondary-200"
                            >
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button 
                            type="button"
                            @click="closeInviteModal" 
                            class="px-4 py-2 border border-secondary-300 rounded-lg text-secondary-700 hover:bg-secondary-50"
                        >
                            Close
                        </button>
                        <button 
                            type="submit" 
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700"
                            :disabled="!inviteEmail || isInviting"
                        >
                            <span x-show="!isInviting">Send Invitation</span>
                            <span x-show="isInviting" class="flex items-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                Sending...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Document Upload Modal -->
        <div 
            x-show="showDocumentModal" 
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="bg-white rounded-lg shadow-xl max-w-md w-full p-6"
                @click.outside="showDocumentModal = false"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
            >
                <h3 class="text-xl font-bold text-secondary-900 mb-4">Upload Document</h3>
                
                <div x-show="documentError" class="mb-4 p-3 bg-danger-50 text-danger-700 rounded-md border border-danger-200">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span x-text="documentError"></span>
                    </div>
                </div>
                
                <form @submit.prevent="uploadDocument" class="space-y-4">
                    <div 
                        x-show="!selectedFile"
                        @dragover.prevent="dragOver = true"
                        @dragleave.prevent="dragOver = false"
                        @drop.prevent="handleFileDrop($event)"
                        class="border-2 border-dashed border-secondary-300 rounded-lg p-6 text-center"
                        :class="{'border-primary-400 bg-primary-50': dragOver}"
                    >
                        <div class="text-secondary-500 mb-2">
                            <i class="fas fa-cloud-upload-alt text-3xl"></i>
                        </div>
                        <p class="text-secondary-700 mb-2">Drag and drop your document here</p>
                        <p class="text-secondary-500 text-sm mb-4">or</p>
                        <label class="cursor-pointer bg-secondary-100 hover:bg-secondary-200 text-secondary-800 px-4 py-2 rounded-lg inline-block">
                            Browse Files
                            <input type="file" class="hidden" @change="handleFileSelect">
                        </label>
                        <p class="mt-4 text-xs text-secondary-500">Supported formats: PDF, TXT, DOCX, MD, Images</p>
                    </div>
                    
                    <!-- Selected file section with null checks -->
                    <div x-show="selectedFile" class="border border-secondary-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="bg-secondary-100 p-2 rounded-lg mr-3">
                                <i class="fas fa-file-alt text-secondary-700"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-secondary-900 truncate" x-text="selectedFile?.name || 'File'"></p>
                                <p class="text-xs text-secondary-500" x-text="selectedFile ? formatFileSize(selectedFile.size) : ''"></p>
                            </div>
                            <button type="button" @click="selectedFile = null" class="text-secondary-500 hover:text-secondary-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button 
                            type="button"
                            @click="showDocumentModal = false" 
                            class="px-4 py-2 border border-secondary-300 rounded-lg text-secondary-700 hover:bg-secondary-50"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700"
                            :disabled="!selectedFile || isUploading"
                        >
                            <span x-show="!isUploading">Upload</span>
                            <span x-show="isUploading" class="flex items-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                Uploading...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Add Keyboard Shortcuts Modal -->
        <div 
            x-show="showKeyboardShortcuts"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6"
                @click.outside="showKeyboardShortcuts = false"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
            >
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-secondary-900">Keyboard Shortcuts</h3>
                    <button @click="showKeyboardShortcuts = false" class="text-secondary-500 hover:text-secondary-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="border-b border-secondary-200 pb-4 mb-4">
                    <p class="text-secondary-600 mb-4">These shortcuts help you navigate and use Triton AI more efficiently.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-medium text-secondary-900 mb-2">Conversation</h4>
                        <ul class="space-y-2">
                            <li class="flex justify-between">
                                <span class="text-secondary-600">New chat</span>
                                <kbd class="px-2 py-1 bg-secondary-100 rounded text-secondary-800 text-sm">Ctrl + N</kbd>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-secondary-600">Send message</span>
                                <kbd class="px-2 py-1 bg-secondary-100 rounded text-secondary-800 text-sm">Enter</kbd>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-secondary-600">New line in message</span>
                                <kbd class="px-2 py-1 bg-secondary-100 rounded text-secondary-800 text-sm">Shift + Enter</kbd>
                            </li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-secondary-900 mb-2">Interface</h4>
                        <ul class="space-y-2">
                            <li class="flex justify-between">
                                <span class="text-secondary-600">Toggle sidebar</span>
                                <kbd class="px-2 py-1 bg-secondary-100 rounded text-secondary-800 text-sm">Ctrl + B</kbd>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-secondary-600">Show shortcuts</span>
                                <kbd class="px-2 py-1 bg-secondary-100 rounded text-secondary-800 text-sm">Ctrl + /</kbd>
                            </li>
                            <li class="flex justify-between">
                                <span class="text-secondary-600">Close modals</span>
                                <kbd class="px-2 py-1 bg-secondary-100 rounded text-secondary-800 text-sm">Esc</kbd>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Info Modal -->
        <div 
            x-show="showInfoModal"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
        >
            <div 
                class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6"
                @click.outside="showInfoModal = false"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95"
            >
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-secondary-900">About Triton AI</h3>
                    <button @click="showInfoModal = false" class="text-secondary-500 hover:text-secondary-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="flex items-center mb-6">
                    <div class="flex-shrink-0 mr-4">
                        <img src="/static/icons/logo.svg" alt="Triton Logo" class="h-16 w-16" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”±</text></svg>'">
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-secondary-900">Triton<span class="text-primary-600">AI</span></h2>
                        <p class="text-secondary-600">Enterprise-grade AI assistant platform</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="font-medium text-secondary-900 mb-2">Features</h4>
                    <ul class="list-disc pl-5 space-y-1 text-secondary-600">
                        <li>Conversational AI with multiple LLM options</li>
                        <li>Multi-modal capabilities with document processing</li>
                        <li>Web search for real-time information</li>
                        <li>Deep research and reasoning capabilities</li>
                        <li>Powerful team collaboration tools</li>
                        <li>Enterprise-grade security and privacy</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <h4 class="font-medium text-secondary-900 mb-2">Models</h4>
                    <p class="text-secondary-600 mb-2">Triton AI provides access to a variety of state-of-the-art language models from:</p>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-2 py-1 bg-primary-50 text-primary-700 rounded-full text-sm">OpenAI</span>
                        <span class="px-2 py-1 bg-primary-50 text-primary-700 rounded-full text-sm">Anthropic</span>
                        <span class="px-2 py-1 bg-primary-50 text-primary-700 rounded-full text-sm">Microsoft</span>
                        <span class="px-2 py-1 bg-primary-50 text-primary-700 rounded-full text-sm">Meta</span>
                        <span class="px-2 py-1 bg-primary-50 text-primary-700 rounded-full text-sm">Cohere</span>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-secondary-900 mb-2">Version</h4>
                    <p class="text-secondary-600">v1.0.0</p>
                </div>
            </div>
        </div>
        
        <!-- Toast Notifications -->
        <div 
            class="fixed bottom-4 right-4 z-50"
            x-data="{ notifications: [] }"
            @notification.window="notifications.push({
                id: Date.now(),
                message: $event.detail.message,
                type: $event.detail.type || 'info',
                timeout: setTimeout(() => { 
                    notifications = notifications.filter(n => n.id !== $event.detail.id)
                }, 5000)
            })"
        >
            <template x-for="notification in notifications" :key="notification.id">
                <div 
                    class="mb-2 p-4 rounded-lg shadow-lg flex items-center"
                    :class="{
                        'bg-danger-50 border border-danger-200 text-danger-700': notification.type === 'error',
                        'bg-success-50 border border-success-200 text-success-700': notification.type === 'success',
                        'bg-warning-50 border border-warning-200 text-warning-700': notification.type === 'warning',
                        'bg-primary-50 border border-primary-200 text-primary-700': notification.type === 'info'
                    }"
                    x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 transform translate-x-8"
                    x-transition:enter-end="opacity-100 transform translate-x-0"
                    x-transition:leave="transition ease-in duration-200"
                    x-transition:leave-start="opacity-100 transform translate-x-0"
                    x-transition:leave-end="opacity-0 transform translate-x-8"
                >
                    <i 
                        :class="{
                            'fas fa-exclamation-circle': notification.type === 'error',
                            'fas fa-check-circle': notification.type === 'success',
                            'fas fa-exclamation-triangle': notification.type === 'warning',
                            'fas fa-info-circle': notification.type === 'info'
                        }" 
                        class="mr-3 text-lg"
                    ></i>
                    <span x-text="notification.message"></span>
                    <button 
                        @click="clearTimeout(notification.timeout); notifications = notifications.filter(n => n.id !== notification.id)"
                        class="ml-4 text-current opacity-70 hover:opacity-100"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </template>
        </div>
    </div>
</body>
</html>
